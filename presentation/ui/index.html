<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Code Review Platform (ECRP)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            border-bottom: 2px solid #007acc;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        button {
            background-color: #007acc;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        button:hover {
            background-color: #005a9e;
        }
        
        .review-card {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #fafafa;
        }
        
        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .review-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }
        
        .review-status {
            padding: 4px 8px;
            border-radius: 4px;
            color: white;
            font-size: 0.9em;
        }
        
        .status-open { background-color: #007acc; }
        .status-under-review { background-color: #ffa500; }
        .status-approved { background-color: #28a745; }
        .status-rejected { background-color: #dc3545; }
        .status-merged { background-color: #6f42c1; }
        
        .review-details {
            margin: 10px 0;
            color: #666;
        }
        
        .review-actions {
            margin-top: 10px;
        }
        
        .comment {
            border-left: 3px solid #007acc;
            padding: 10px;
            margin: 10px 0;
            background-color: #f8f9fa;
        }
        
        .api-response {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-left: 4px solid #007acc;
            display: none;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Enhanced Code Review Platform (ECRP)</h1>
        
        <div id="create-review-section">
            <h2>Create New Code Review</h2>
            <form id="create-review-form">
                <div class="form-group">
                    <label for="title">Title:</label>
                    <input type="text" id="title" required>
                </div>
                
                <div class="form-group">
                    <label for="description">Description:</label>
                    <textarea id="description" rows="4" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="source-branch">Source Branch:</label>
                    <input type="text" id="source-branch" required>
                </div>
                
                <div class="form-group">
                    <label for="target-branch">Target Branch:</label>
                    <input type="text" id="target-branch" required>
                </div>
                
                <div class="form-group">
                    <label for="requester-id">Requester ID:</label>
                    <input type="text" id="requester-id" value="user-123" required>
                </div>
                
                <button type="submit">Create Review</button>
            </form>
        </div>
        
        <div id="reviews-section">
            <h2>Code Reviews</h2>
            <div id="reviews-list">
                <!-- Reviews will be loaded here -->
            </div>
        </div>
        
        <div id="api-response" class="api-response">
            <h3>API Response</h3>
            <pre id="response-content"></pre>
        </div>
    </div>

    <script>
        // API base URL - adjust as needed for your deployment
        const API_BASE_URL = 'http://localhost:5000/api';
        
        // Load reviews on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadReviews();
        });
        
        // Create review form submission
        document.getElementById('create-review-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const sourceBranch = document.getElementById('source-branch').value;
            const targetBranch = document.getElementById('target-branch').value;
            const requesterId = document.getElementById('requester-id').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/code-reviews`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title,
                        description,
                        source_branch: sourceBranch,
                        target_branch: targetBranch,
                        requester_id: requesterId
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showApiResponse(`Successfully created review: ${result.id}`, result);
                    // Reset form
                    document.getElementById('create-review-form').reset();
                    // Reload reviews list
                    loadReviews();
                } else {
                    showApiResponse(`Error: ${result.error}`, result);
                }
            } catch (error) {
                showApiResponse(`Error: ${error.message}`, { error: error.message });
            }
        });
        
        // Function to load reviews from API
        async function loadReviews() {
            try {
                // For demo purposes, we'll create some mock reviews
                // In a real implementation, we would call the API to get reviews
                displayReviews(getMockReviews());
            } catch (error) {
                showApiResponse(`Error loading reviews: ${error.message}`, { error: error.message });
            }
        }
        
        // Function to display reviews
        function displayReviews(reviews) {
            const reviewsList = document.getElementById('reviews-list');
            reviewsList.innerHTML = '';
            
            reviews.forEach(review => {
                const reviewCard = document.createElement('div');
                reviewCard.className = 'review-card';
                
                // Map status to CSS class
                let statusClass = '';
                switch(review.status) {
                    case 'open':
                        statusClass = 'status-open';
                        break;
                    case 'under_review':
                        statusClass = 'status-under-review';
                        break;
                    case 'approved':
                        statusClass = 'status-approved';
                        break;
                    case 'rejected':
                        statusClass = 'status-rejected';
                        break;
                    case 'merged':
                        statusClass = 'status-merged';
                        break;
                    default:
                        statusClass = 'status-open';
                }
                
                reviewCard.innerHTML = `
                    <div class="review-header">
                        <div class="review-title">${review.title}</div>
                        <div class="review-status ${statusClass}">${review.status.replace('_', ' ').toUpperCase()}</div>
                    </div>
                    <div class="review-details">
                        <p><strong>Source:</strong> ${review.source_branch} | <strong>Target:</strong> ${review.target_branch}</p>
                        <p><strong>Requester:</strong> ${review.requester_id}</p>
                        <p><strong>Description:</strong> ${review.description}</p>
                        <p><strong>Files Changed:</strong> ${review.files_changed} | 
                           <strong>Comments:</strong> ${review.comments_count}</p>
                        <p><strong>Risk Score:</strong> ${review.risk_score ? review.risk_score.toFixed(2) : 'N/A'}</p>
                    </div>
                    <div class="review-actions">
                        <button onclick="approveReview('${review.id}')">Approve</button>
                        <button onclick="requestChanges('${review.id}')">Request Changes</button>
                        <button onclick="mergeReview('${review.id}')">Merge</button>
                        <button onclick="showComments('${review.id}')">Show Comments</button>
                    </div>
                `;
                
                reviewsList.appendChild(reviewCard);
            });
        }
        
        // Function to get mock reviews for demonstration
        function getMockReviews() {
            return [
                {
                    id: 'review-1',
                    title: 'Fix user authentication bug',
                    description: 'This PR fixes a critical bug in the user authentication flow',
                    source_branch: 'feature/auth-fix',
                    target_branch: 'main',
                    requester_id: 'user-123',
                    status: 'open',
                    files_changed: 3,
                    comments_count: 2,
                    risk_score: 75.5
                },
                {
                    id: 'review-2',
                    title: 'Add new dashboard widget',
                    description: 'Implement a new widget to display system metrics',
                    source_branch: 'feature/dashboard-widget',
                    target_branch: 'develop',
                    requester_id: 'user-456',
                    status: 'approved',
                    files_changed: 5,
                    comments_count: 0,
                    risk_score: 42.0
                },
                {
                    id: 'review-3',
                    title: 'Update payment processing',
                    description: 'Upgrade payment processing to support new payment methods',
                    source_branch: 'feature/payment-upgrade',
                    target_branch: 'main',
                    requester_id: 'user-789',
                    status: 'under_review',
                    files_changed: 8,
                    comments_count: 5,
                    risk_score: 88.3
                }
            ];
        }
        
        // Function to approve a review
        async function approveReview(reviewId) {
            const reviewerId = prompt('Enter your user ID for approval:');
            if (!reviewerId) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/code-reviews/${reviewId}/approve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        reviewer_id: reviewerId
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showApiResponse(`Successfully approved review: ${reviewId}`, result);
                    loadReviews();
                } else {
                    showApiResponse(`Error: ${result.error}`, result);
                }
            } catch (error) {
                showApiResponse(`Error: ${error.message}`, { error: error.message });
            }
        }
        
        // Function to request changes
        async function requestChanges(reviewId) {
            const reviewerId = prompt('Enter your user ID for requesting changes:');
            if (!reviewerId) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/code-reviews/${reviewId}/request-changes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        reviewer_id: reviewerId
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showApiResponse(`Successfully requested changes for review: ${reviewId}`, result);
                    loadReviews();
                } else {
                    showApiResponse(`Error: ${result.error}`, result);
                }
            } catch (error) {
                showApiResponse(`Error: ${error.message}`, { error: error.message });
            }
        }
        
        // Function to merge a review
        async function mergeReview(reviewId) {
            const mergerId = prompt('Enter your user ID for merging:');
            if (!mergerId) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/code-reviews/${reviewId}/merge`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        merger_id: mergerId
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showApiResponse(`Successfully merged review: ${reviewId}`, result);
                    loadReviews();
                } else {
                    showApiResponse(`Error: ${result.error}`, result);
                }
            } catch (error) {
                showApiResponse(`Error: ${error.message}`, { error: error.message });
            }
        }
        
        // Function to show comments (placeholder)
        function showComments(reviewId) {
            alert(`Showing comments for review: ${reviewId}\nThis would open a comment view in a real implementation.`);
        }
        
        // Function to show API response
        function showApiResponse(message, data) {
            const responseDiv = document.getElementById('api-response');
            const responseContent = document.getElementById('response-content');
            
            responseContent.textContent = `Message: ${message}\n\nData: ${JSON.stringify(data, null, 2)}`;
            responseDiv.style.display = 'block';
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                responseDiv.style.display = 'none';
            }, 10000);
        }
    </script>
</body>
</html>